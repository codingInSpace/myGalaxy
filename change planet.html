<!DOCTYPE html>
<html>
	<head>
		<title> Solsystem av Anton Kaiser</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script src="js/three.js"></script>

		<script src="js/TrackballControls.js"></script>
		
		<script>
			//Klickvariabler
			var mouse;
			var raycaster;
			var objects = [];

			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 60, window.innerWidth/window.innerHeight, 0.1, 1000 );
			camera.position.z = 30;
			scene.add(camera);
			
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			//Skapar en grupp som ska innehålla hela scengrafen
			sceneGraph = new THREE.Object3D;
			
			
			var A_light = new THREE.AmbientLight( 0x404040 ); // soft white light
			sceneGraph.add( A_light );
			
			
			var light = new THREE.DirectionalLight( 0xffffff,0.7 );
			light.position.set( 20, 20, 20 ).normalize();
			sceneGraph.add(light);

			
			sunGroup =new THREE.Object3D;
			//***********************************
			var sunGeometry = new THREE.SphereGeometry( 5, 32, 32 );
			var sunMaterial = new THREE.MeshPhongMaterial();
			
			sunMaterial.map    = THREE.ImageUtils.loadTexture('textures/suntexture.jpg');
			sunMaterial.bumpMap    = THREE.ImageUtils.loadTexture('textures/suntexture.jpg');
			sunMaterial.bumpScale = 0.06;
			sunMaterial.specular  = new THREE.Color('grey');
			
			var sunSphere = new THREE.Mesh( sunGeometry, sunMaterial );
			sunGroup.add( sunSphere);

			//Skapa en måne.
			moonGroup = new THREE.Object3D;

			var moonGeometry = new THREE.SphereGeometry( 2, 32,32 );
			var moonMaterial = new THREE.MeshPhongMaterial();

			moonMaterial.map    = THREE.ImageUtils.loadTexture('textures/moontexture.jpg');
			moonMaterial.bumpMap    = THREE.ImageUtils.loadTexture('textures/moontexture.jpg');
			moonMaterial.bumpScale = 0.06;
			moonMaterial.specular  = new THREE.Color('grey');
			
			var moonSphere = new THREE.Mesh( moonGeometry, moonMaterial );
			moonSphere.position.x = 15;

			moonGroup.add( moonSphere);
			sunGroup.add(moonGroup);

			//Skapa en till måne
			moon2Group = new THREE.Object3D;

			var moon2Geometry = new THREE.SphereGeometry( 3, 32,32 );
			var moon2Material = new THREE.MeshPhongMaterial();

			moon2Material.map    = THREE.ImageUtils.loadTexture('textures/moontexture.jpg');
			moon2Material.bumpMap    = THREE.ImageUtils.loadTexture('textures/moontexture.jpg');
			moon2Material.bumpScale = 0.06;
			moon2Material.specular  = new THREE.Color('grey');
			
			var moon2Sphere = new THREE.Mesh( moon2Geometry, moon2Material );
			moon2Sphere.position.x = 20;

			moon2Group.add( moon2Sphere);
			sunGroup.add(moon2Group);
			//***********************************

			//Lägg till alla klickbara objekt i en array.
			objects.push(moonSphere);
			objects.push(sunSphere);
			objects.push(moon2Sphere);

			//Kod för att hantera klick och upptäcka vilket objekt som blev klickat på.
			//***********************************

			raycaster = new THREE.Raycaster();
			var intersects = raycaster.intersectObjects( objects );
		
			mouse = new THREE.Vector2();
			document.addEventListener( 'mousedown', onDocumentMouseDown, false );
			document.addEventListener( 'touchstart', onDocumentTouchStart, false );

			function onDocumentTouchStart( event ) {
		
				event.preventDefault();
				
				event.clientX = event.touches[0].clientX;
				event.clientY = event.touches[0].clientY;
				onDocumentMouseDown( event );
			}	
			
			function onDocumentMouseDown( event ) {

				event.preventDefault();

				mouse.x = ( event.clientX / renderer.domElement.width ) * 2 - 1;
				mouse.y = - ( event.clientY / renderer.domElement.height ) * 2 + 1;


				raycaster.setFromCamera( mouse, camera );

				intersects = raycaster.intersectObjects( objects );

				if ( intersects.length > 0 ) {

					console.log("Click on planet registred.");
					//camera.lookAt(temp.position);
					temp = intersects[0].object;

					//controls.target = intersects[ 0 ].object.position.clone();
				}


			}
			//temp är planeten i fokus, har solen som startvärde.
			var temp = sunSphere;
			//temp2 är planeten man precis klickat på.
			var temp2 = sunSphere;
			//timer används i förflyttnings-loopen.
			var timer = 0;
			//variabler för att temporärt spara en position.
			var posx, posz, roty, camzoom;
			//rotationGroup används för att motverka den markerade planetens rotation.
			rotationGroup = new THREE.Object3D;
			//**********************************		
			
			
			galaxyGroup = new THREE.Object3D;
			//**********************************
			var galaxyGeometry = new THREE.SphereGeometry( 300, 32, 32 );
			var galaxyMaterial = new THREE.MeshPhongMaterial();
			
			galaxyMaterial.map    = THREE.ImageUtils.loadTexture('textures/suntexture.png');
			//galaxyMaterial.specular  = new THREE.Color('grey');
			galaxyMaterial.side = THREE.DoubleSide;
			
			var galaxySphere = new THREE.Mesh( galaxyGeometry, galaxyMaterial );
		
			galaxyGroup.add( galaxySphere);
			//*********************************
			
			
			//rotationGroup ligger under sceneGraph och är parent till galaxyGroup.
			sceneGraph.add(rotationGroup);
			rotationGroup.add(galaxyGroup);

			//Lägger till grupper till scengraf
			galaxyGroup.add(sunGroup);
			
			//Lägger till scengraf till scen
			scene.add(sceneGraph);
			
			sceneGraph.rotation.x += 0.5;
			
			controls = new THREE.TrackballControls( camera );
			controls.zoomSpeed = 0.5;
			controls.panSpeed = 0;
			controls.rotateSpeed = 0.5;
			

			//Renderingsloop
			var render = function () {

				//Variabeln time används till timern och även planeternas rotation.
				var time = Date.now() * 0.0005;

				requestAnimationFrame( render );
				controls.update();

				//Aktiveras när man klickar på en annan planet.
				if(temp != temp2) {
					if(timer == 0){
						//Timern börjar på pi och går ner till 0.
						timer = Math.PI;
						//Spara den förra planetens position och rotation.
						posx = galaxyGroup.position.x;
						posz = galaxyGroup.position.z;
						roty = galaxyGroup.rotation.y + rotationGroup.rotation.y;
						camzoom = camera.position.z;
						console.log("Paborjar hopp");
					}
					//Skapa en mjuk övergång mellan nya och gamla positionen mha cosinus.
					galaxyGroup.position.x = posx*(1-Math.cos(timer))/2 - temp.position.x*(1+Math.cos(timer))/2;
					galaxyGroup.position.z = posz*(1-Math.cos(timer))/2 - temp.position.z*(1+Math.cos(timer))/2;
					rotationGroup.rotation.y = roty*(1-Math.cos(timer))/2 - temp.rotation.y*(1+Math.cos(timer))/2;
					//OBS: raden under är en idé för att klara av sista punkten under planetförflyttning,
					//	dvs att automatisk skala zoomnivån efter planetens radie. För att den ska gå att implementera måste
					//	det gå att komma åt en planets radie på ett bra sätt. /Albin
					//camera.position.z = camzoom + (1-Math.cos(timer))*(1/2)*temp.;

					//Hastigheten med vilken förflyttningen sker.
					timer -= 0.02;
						
					if(timer < 0){
						timer = 0;
						//När förflyttningen är klar sätts temp2 (det klickade objektet) till objektet som nu är i fokus.
						temp2 = temp;
						//Denna loop ska se till att rotationen inte nollställs direkt efter ett hopp.
						for(var i = 0; i < objects.length; i++)
							if(Math.abs(objects[i].rotation.y) > Math.PI*2) {
								objects[i].rotation.y = objects[i].rotation.y - Math.PI*2;
								console.log("Nollstalld under hopp");
							}
						console.log("Fardig med hopp");
					}
				} else {
					//Detta sker när det inte är ett hopp på g.
					galaxyGroup.position.x = -temp.position.x;
					galaxyGroup.position.z = -temp.position.z;
					//Motverkar planeten i fokus's rotation så att den står stilla.
					rotationGroup.rotation.y = -temp.rotation.y;

					//Denna loop nollställer planetens rotation vid ett helt varv.
					for(var i = 0; i < objects.length; i++)
						if(Math.abs(objects[i].rotation.y) > Math.PI*2) {
							objects[i].rotation.y = 0;
							console.log("Nollstalld utanfor hopp");
						}
				}

				//Dessa rotationer är ganska snabba, lite för snabba.
				moonSphere.rotation.y += 0.01;
				sunSphere.rotation.y -= 0.001;
				moon2Sphere.rotation.y -= 0.02;

				//Använder position istället för rotation, det fungerar bättre av någon anledning.
				moonSphere.position.x = Math.cos( time * 0.5 ) * 10;
				moonSphere.position.z = Math.sin( time * 0.5 ) * 10;

				renderer.render(scene, camera);
			};

			render();
		</script>
	</body>
</html>
